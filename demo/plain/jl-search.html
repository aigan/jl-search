<!doctype html>
<meta name="viewport" content="width=device-width, initial-scale=1">






<!-- Telemetry -->

<script>
  
  // window._logging = [];
  // const console_default = {};
  // for (const channel of ["log", "warn", "error"]) {
  //   console_default[channel] = console[channel].bind(console);
  //   console[channel] = (...args) => track(channel, args);
  // }

  // window.onerror = (message, source, lineno, colno, error) => {
  //   if (!error) {
  //     error = Error(message);
  //     Object.assign(error, { source, lineno, colno });
  //   }
  //   track("error", [error]);
  //   return true;
  // }

  // window.addEventListener("unhandledrejection", ev => {
  //   track("unhandledrejection", [ev.reason]);
  //   ev.preventDefault();
  // })

  // function track(channel, args) {
  //   if (console_default[channel]) console_default[channel].apply(console, args);
  //   // console.debug(channel, Date.now(), ...args);
  //   window._logging.push([channel, Date.now(), ...args]);
  // }

  // window.addEventListener('load',
  //   () => console.log("Start tracking", window._logging),
  //   { once: true }
  // );

</script>






<!-- Main theme -->

<link rel="stylesheet" href="./theme.css" />
<style>
  /* For keeping sizing in css, avoid fractions. */

  :root {
    --padding: .75em;
    --lineheight: 1.5;
    --disabled-opacity: .38;
    --font-family: sans-serif;
    --border-radius: .25rem;
    --border-width: .125rem;
    --border-width-focus: .1875rem;
    --outline-color: var(--c-outline, gray);
    --input-bg: var(--c-surface-bright);
    --input-ink: var(--c-on-surface);
    --selected-bg: var(--c-tertiary-container);
    --selected-ink: var(--c-on-tertiary-container);
    --hover-color: var(--c-on-surface, black);
    --focus-color: var(--c-primary, green);
    --focus-bg: var(--c-surface-dim, lightgray);
    --highlight-bg: var(--c-secondary-container);
    --active-color: var(--c-tertiary-container, orange);
    --disabled-color: var(--c-outline-a33, silver);
    --error-ink: var(--c-error, red);
    --error-container-bg: var(--c-error-container);
    --error-container-ink: var(--c-on-error-container);
  }
</style>






<!-- =====  Symbols  ====== -->

<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:FILL@0..1&display=block" />
<script type="module">
  // Hide symbols until the font has loaded. Would have to define @font-face
  // ourselves to get better control over when the actual font is ready. Using
  // fonts.googleapis inderection is not perfect.
  await document.fonts.load("1em Material Symbols Outlined");
  document.documentElement.classList.add('loaded-symbols');
  // console.log("Symbols loaded");
</script>
<style>
  .symbol {
    font-family: 'Material Symbols Outlined';
    line-height: 1;
    display: inline-block;
    width: 1em;
    overflow: hidden;
    transition: opacity 1.5s;
  }

  html:not(.loaded-symbols) .symbol {
    opacity: 0;
  }

  input[type="checkbox"]:checked::before {
    font-family: 'Material Symbols Outlined';
    content: "check";
  }

  jl-search>fieldset .symbol {
    font-size: 1.5em;
    /* max set to line-height to not increase total */
    user-select: none;
    padding: calc(var(--_padding) - .25em);
  }
</style>






<!-- =====  Theme color slider  ===== -->

<input id="hue" type="range" min="1" max="360">
<input id="chroma" type="range" min="0" max="0.47" step="0.01">
<script>
  const $hue = document.querySelector("#hue");
  const $chr = document.querySelector("#chroma");
  $hue.value = localStorage.primary_hue;
  $chr.value = localStorage.primary_chroma;

  $hue.oninput = set_color;
  $chr.oninput = set_color;
  const style = document.documentElement.style;
  set_color();
  function set_color() {
    style.setProperty("--primary-hue", $hue.value);
    localStorage.primary_hue = $hue.value;
    style.setProperty("--primary-chroma", $chr.value);
    localStorage.primary_chroma = $chr.value;
  }
</script>
<style>
  #hue,
  #chroma {
    display: block;
    width: calc(75vw - 3rem);
    /* Leave room for dark-light toggle */
    margin: 0 auto;
  }

  @media (max-width: 600px) {

    #hue,
    #chroma {
      margin-bottom: 1rem;
    }
  }
</style>






<!-- =====  Search component  ===== --->

<link rel="stylesheet" href="../../jl-search.css" />
<style>
  jl-search {
    --hr-color: var(--c-surface-dim, silver);
    --shadow-color: var(--c-shadow, black);
    --input-height: calc(var(--lineheight) * 1em + 2 * var(--padding));
    max-width: 25em;
  }


  /* Avoid FOUC while main style loads */
  jl-search[init] {
    height: var(--input-height);
  }

  jl-search[init]>* {
    display: none;
  }

  @keyframes fade_in {
    0% {
      opacity: 0
    }

    100% {
      opacity: 1
    }
  }

  jl-search ul>li {
    display: grid;
    grid-template-columns: 15% auto;
    column-gap: var(--padding);
  }

  ul>li>p {
    font-size: .8em;
    margin: 0;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    animation: fade_in 1s linear forwards;
  }

  ul>li>img {
    object-fit: cover;
    /* Center top works much better than golden ratio for most wikipedia image
    thumbs */
    object-position: center top;
    grid-row: span 2;
    width: 100%;
    flex: 0 0 auto;
    aspect-ratio: 1 / 1;
    outline: thin solid var(--outline-color);
    transition: filter 1s, opacity 1s;
  }

  ul>li>img.default {
    filter: blur(2px);
    opacity: .3;
    outline: none;
  }
</style>
<script type="module">
  import {init} from "../../jl-search.mjs";
  init();

  // eslint-disable-next-line no-unused-vars
  const log = console.log.bind(console);
  // May be necessary to wait on element upgrade
  // await customElements.whenDefined("jl-search");

  const $inp1 = document.querySelector("[for=field1] + jl-search");
  // log("attatching search", $jl_inp._id);
  const $delay = document.querySelector("#delay");
  const url_search = "https://wiki.para.se:9071/s/";

  $inp1.search = async function search({ query }) {
    if (query === "i am lying") throw Error("BOOM");

    const query_out = encodeURIComponent(query);
    let opts = "?" + ($delay.checked ? "delay=300" : "");
    const res = await fetch(url_search + query_out + opts);
    const json = await res.json();
    return json;
  }

  $delay.oninput = () => localStorage.use_delay = $delay.checked;
  $delay.checked = localStorage.use_delay === "true";

  const $anim = document.querySelector("#anim");
  $anim.oninput = () => {
    localStorage.more_anim = $anim.checked;
    $inp1.toggleAttribute("more-anim", $anim.checked);
  }
  $anim.checked = localStorage.more_anim === "true";
  $inp1.toggleAttribute("more-anim", $anim.checked);

  const $state = $inp1.querySelector(".state");
  const states = {
    closed: "expand_more",
    opened: "expand_less",
    // loading: "progress_activity",
    loading: $inp1.spinner,
    error: "sentiment_very_dissatisfied",
  }

  $inp1.render_state_html = state => {
    //Could also do this in css with before content
    // log("setting state", state, "html to", states[state] );
    $state.innerHTML = states[state];
  }

  const url_sum = "https://en.wikipedia.org/api/rest_v1/page/summary/";
  const recs = new Map();
  $inp1.prepare_options = async q_res => {
    // log("prepare", q_res);
    const found = q_res.found;
    const max = Math.min(found.length, $inp1._page_size);
    const recs_p = [];
    for (let i = 0; i < max; i++) {
      const opt_id = found[i];
      recs_p.push(get_rec(opt_id));
    }
    // log("prepared", recs_p);

    // Returning Promise.all(recs_p) will wait till all is loaded. But we
    // rather just return directly and update the content after.
    // return Promise.all( recs_p);
  }

  function get_rec(opt_id) {
    // log("get rec", title);
    if (recs.has(opt_id)) return recs.get(opt_id);
    const promise = load_rec(opt_id);
    recs.set(opt_id, promise);
    // Replace the promise with the result when done
    // promise.then( rec=> recs.set(title, rec) );
    return promise;
  }

  async function load_rec(opt_id) {
    // log("Loading", title);
    const res = await fetch(url_sum + encodeURIComponent(opt_id));
    return await res.json();
  }

  const url_thumb_default = "https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/Wikipedia-logo-v2.svg/225px-Wikipedia-logo-v2.svg.png";

  $inp1.render_item_content = ($li, opt_id) => {
    const rec_p = recs.get(opt_id);
    const title = $inp1.format(opt_id);

    const $img = document.createElement("img");
    const $title = document.createElement("b");
    const $desc = document.createElement("p");

    $img.src = url_thumb_default;
    $img.classList.add("default");
    $title.innerText = title;

    $li.replaceChildren($img, $title, $desc);

    rec_p.then(rec => {
      $desc.innerText = rec.description ?? "";
      if (rec.thumbnail) {
        $img.src = rec.thumbnail.source;
        $img.classList.remove("default");
      }
    }).catch(err => {
      console.warn("Failed to get", opt_id, err);
    })
  }

  $inp1.to_query = text => $inp1.parse(text).toLowerCase();

  // Keeping trailing space allows search for word break
  $inp1.parse = text => text.trimStart().replaceAll(/\s+/g, "_");

  $inp1.format = opt_id => opt_id.replaceAll("_", " ");

  $inp1.addEventListener("change", async ev => {
    // const opt_id = $jl_inp.value;
    const opt_id = ev.target.value;
    // log("handling change event");
    const $art = document.querySelector("article");

    // Skip fadeout if this is the first article shown
    const fade_out = $art.hidden
      ? Promise.resolve()
      : $art.animate([{ opacity: 1 }, { opacity: 0 }], 500);

    const rec = await get_rec(opt_id);

    // Start loading image while fadeout animates
    const $img = document.createElement("img");
    const img_loaded = new Promise((resolve, reject) => {
      if (!rec.thumbnail) return resolve();
      $img.src = rec.thumbnail.source;
      $img.onload = resolve;
      $img.onerror = reject;
    });

    await fade_out.finished;
    $art.style.opacity = 0;

    $art.hidden = false;
    document.querySelector("article figure").hidden = !rec.thumbnail;
    document.querySelector("article img").replaceWith($img);
    document.querySelector("article h1").innerHTML = rec.titles.display;
    document.querySelector("article summary").innerHTML = rec.extract_html;
    document.querySelector("article figcaption").innerHTML = rec.description ?? "";
    document.querySelector("article > a").href = rec.content_urls.desktop.page;

    await img_loaded; // start fade in after image loaded
    const fade_in = $art.animate([{ opacity: 0 }, { opacity: 1 }], 500);
    await fade_in.finished;
    $art.style.opacity = 1;
  });


  document.querySelector("form").onsubmit = () => false;

</script>






<!-- ===== Theme dark / light switch  ===== -->

<nav class="theme-switch symbol"></nav>
<script>
  const $doc = document.documentElement;
  const mql_dark = window.matchMedia('(prefers-color-scheme: dark)');
  if (localStorage.theme)
    $doc.dataset.theme = localStorage.theme;
  else if (mql_dark.matches)
    $doc.dataset.theme = "dark";

  mql_dark.addEventListener('change',
    ev => {
      if (localStorage.theme) return; // keep overrid
      const theme = mql_dark.matches ? "dark" : "light";
      $doc.dataset.theme = theme;
    }
  )
  document.querySelector(".theme-switch").onclick = () => {
    const theme_cur = $doc.dataset.theme;
    const theme_def = mql_dark.matches ? "dark" : "light";
    const theme_new = theme_cur === "dark" ? "light" : "dark";

    if (theme_new === theme_def)
      delete localStorage.theme;
    else
      localStorage.theme = theme_new;

    $doc.dataset.theme = theme_new;
  }
</script>
<style>
  nav.theme-switch {
    position: fixed;
    top: 1rem;
    right: 1rem;
    font-size: 2rem;
    font-variation-settings: 'FILL' 1;
    cursor: pointer;
    filter: drop-shadow(0 0 2px yellow);
    z-index: 1;
  }

  nav.theme-switch::before {
    content: "dark_mode";
  }

  [data-theme="dark"] nav.theme-switch::before {
    content: "light_mode";
  }
</style>






<!-- ======  MAIN PAGE ====== -->

<style>
  body {
    margin: 1rem 3rem;
    font-family: var(--font-family);
    line-height: var(--lineheight);
  }

  @media (max-width: 600px) {
    body {
      margin: 1rem;
    }
  }

  label[for] {
    padding: var(--padding) 0;
    white-space: nowrap;
  }

  label[for]:has(+jl-search input:disabled) {
    opacity: var(--disabled-opacity);
  }

  form {
    margin-top: 2rem;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: var(--padding);
    /* max-width: 80vw; */
  }

  form>div {
    display: flex;
    align-items: center;
  }

  article {
    view-transition-name: article;
  }

  figure {
    float: left;
    margin: 0 1em 0 0;
    padding: 1em;
    border: var(--border-width) color-mix(in oklch, var(--outline-color), transparent 80%) solid;
    width: min-content;
    display: none;
    background: var(--c-surface-container-highest);
  }

  figure:has(img[src]) {
    display: block;
    box-sizing: border-box;
  }

  figcaption {
    text-align: center;
    font-size: .8em;
  }

  article>a {
    font-size: 1.5em;
    float: right;
  }

  article>a::after {
    content: "arrow_forward";
    font-family: 'Material Symbols Outlined';
    vertical-align: bottom;
  }

  @media (max-width: 40rem) {
    figure {
      float: none;
      margin: 1em 0;
      width: 100%;
    }

    article img {
      width: 100%;
    }
  }
</style>
<form>
  <label for="delay">Slow down</label>
  <div>
    <input id="delay" type="checkbox">
    <span>Simulate slower server responses</span>
  </div>

  <label for="anim">Animate</label>
  <div>
    <input id="anim" type="checkbox">
    <span>Even more unecessary animations</span>
  </div>

  <label for="field1">Search</label>
  <jl-search init>
    <fieldset>
      <span class="symbol">dictionary</span>
      <input id="field1" placeholder="wikipedia articles" />
      <span class="state symbol"></span>
    </fieldset>
    <nav>
      <section>
        <hr>
        <ul></ul>
        <hr>
        <footer></footer>
      </section>
    </nav>
  </jl-search>

  <!-- <label for="name">Name</label>
  <input name="name"> -->

</form>

<article hidden>
  <figure>
    <img>
    <figcaption></figcaption>
  </figure>
  <h1></h1>
  <summary></summary>
  <a>read more</a>
</article>
